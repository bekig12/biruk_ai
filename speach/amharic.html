<!DOCTYPE html> 

<html lang="en">  

<head>  

  <meta charset="UTF-8">  

  <meta name="viewport" content="width=device-width, initial-scale=1.0">  

  <title>Speech to Text Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>  

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">   

</head>  

<body class="bg-black">  

<div class="flex p-2">

<div class="spinner-border text-light loader d-none" role="status">

  <span class="sr-only">Loading...</span>

</div>
  <div class="absolute top-3 right-4 z-50 menu-container text-white !decoration-0">
    <button id="hamburger" class="text-3xl hover:text-blue-400 text-white">☰</button>
    <div id="menuLinks" class="flex flex-col mt-2 gap-1 hidden">
      <a href="/english" id="btnEn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">English</a>
      <a href="/" id="btnAm" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Amharic</a>
      <a href="/englishTxt" id="btnEn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">English T</a>
      <a href="/amharicTxt" id="btnAm" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Amharic T</a> 
      <a href="/haddiyisaT" id="btnEn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Haddiyisa T</a>
      <a href="/haddiyisa" id="btnAm" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">Haddiyisa</a>      
      <button id="btnEditor" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded text-sm">Editor</button>
    </div>
  </div>
<div class="w-full h-screen flex items-center justify-center">

  <img src="/assets/bruk_robot.png" class="max-w-150 w-full">

  <video src="/assets/bruk_robot_talk.mp4" controls class="max-w-150 w-full pointer-events-none hidden" autoplay loop></video>

</div>

<audio id="audioPlayer" controls style="margin-top: 20px; display: block;" class="sr-only"></audio>

<!--settings-->
<div id="editorPage" class="absolute top-0 z-1000 page hidden bg-slate-950 text-slate-100 overflow-y-auto pb-20 absolute top-0 z-1000" onclick="(e)=>e.stopPropagation()">

  <div id="passwordSection" class="flex items-center justify-center min-h-screen p-6">
    <div class="bg-slate-900 border border-slate-800 p-8 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex justify-center mb-4"><i class="fas fa-terminal text-blue-500 text-4xl"></i></div>
      <h2 class="text-xl font-bold mb-6 text-center tracking-tight">System Authentication</h2>
      <input id="passwordInput" type="password" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none mb-4" placeholder="Enter Admin Password">
      <button onclick="checkPassword()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold cursor-pointer">Enter Dashboard</button>
      <p id="errorMsg" class="text-red-400 hidden mt-4 text-center text-sm">Invalid Credentials</p>
    </div>
  </div>

  <div id="editorSection" class=" max-w-6xl hidden mx-auto p-6 mt-12">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
    <div>
      <h1 class="text-3xl font-bold text-white tracking-tighter uppercase">
        Bruk AI <span class="text-blue-500 italic">Admin</span>
      </h1>
      <p class="text-slate-500 text-sm font-mono mt-1">> configure_system_assets --v2.0</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left Column: Greeting + Uploads -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Robot UI, Voice Data, Bot MP4 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

        <!-- Robot UI -->
        <form id="robotUIForm" class="bg-slate-900 p-5 rounded-2xl border border-slate-800 text-center" onsubmit="saveRobotUI(event)">
          <i class="fas fa-camera text-blue-500 mb-3 text-xl"></i>
          <p class="text-[10px] font-bold text-slate-400 uppercase mb-4">Robot UI</p>
          <label class="block w-full py-2 bg-slate-800 hover:bg-blue-900/30 border border-slate-700 rounded-lg cursor-pointer text-xs font-bold transition-all">
            <input type="file" class="hidden" accept="image/*" onchange="previewMedia(this, 'img')">
            Select Image
          </label>
          <button type="submit" class="mt-3 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold cursor-pointer">
            <i class="fas fa-save"></i> Save Image
          </button>
        </form>

        <!-- Voice Data -->
        <form action="https://biruk-ai.onrender.com/changeAudio" method="POST" enctype="multipart/form-data" id="voiceForm" class="bg-slate-900 p-5 rounded-2xl border border-slate-800 text-center">
          <i class="fas fa-waveform text-purple-500 mb-3 text-xl"></i>
          <p class="text-[10px] font-bold text-slate-400 uppercase mb-4">Voice Data</p>
          <label class="block w-full py-2 bg-slate-800 hover:bg-purple-900/30 border border-slate-700 rounded-lg cursor-pointer text-xs font-bold transition-all">
            <input type="file" class="sr-only" accept="audio/*"
            name="audio"
            required>
            Select Audio
          </label>
          <input type="text" name="name" value="AmhstartAudio.mp3"required=""/>
          <button type="submit" class="mt-3 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold cursor-pointer">
            <i class="fas fa-save"></i> Save Audio
          </button>
        </form>

        <!-- Bot MP4 -->
        <form id="videoForm" class="bg-slate-900 p-5 rounded-2xl border border-slate-800 text-center" onsubmit="saveVideo(event)">
          <i class="fas fa-film text-red-500 mb-3 text-xl"></i>
          <p class="text-[10px] font-bold text-slate-400 uppercase mb-4">Bot MP4</p>
          <label class="block w-full py-2 bg-slate-800 hover:bg-red-900/30 border border-slate-700 rounded-lg cursor-pointer text-xs font-bold transition-all">
            <input type="file" class="hidden" accept="video/mp4" onchange="previewMedia(this, 'video')">
            Select Video
          </label>
          <button type="submit" class="mt-3 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold cursor-pointer">
            <i class="fas fa-save"></i> Save Video
          </button>
        </form>

      </div>
    </div>

    <!-- Right Column: Live Assets Preview -->
    <div class="space-y-6">
      <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 sticky top-6">
        <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-6">Live Assets Preview</h3>

        <div class="space-y-6">
          <div>
            <p class="text-[10px] text-slate-500 mb-2 font-mono">/active_video.mp4</p>
            <div class="aspect-video bg-black rounded-lg overflow-hidden border border-slate-800 shadow-2xl">
              <video id="editorVideoPreview" class="w-full h-full object-cover" controls>
                <source src="beki_robot_talk.mp4" type="video/mp4">
              </video>
            </div>
          </div>

          <div>
            <p class="text-[10px] text-slate-500 mb-2 font-mono">/active_robot.png</p>
            <div class="h-32 bg-black rounded-lg overflow-hidden border border-slate-800 flex items-center justify-center p-2">
              <img id="editorImagePreview" src="/assets/bruk_robot.png" class="max-h-full object-contain">
            </div>
          </div>

          <div>
            <p class="text-[10px] text-slate-500 mb-2 font-mono">/active_voice.wav</p>
            <audio id="editorAudioPreview" class="w-full h-10" controls></audio>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
</div>
<script>  

let isSpeaking = false;  

let recognition = null;  

let micReady = false;  

const loader = document.querySelector(".loader");  

const video = document.querySelector("video");  

const image = document.querySelector("img");  

const audioPlayer = document.getElementById("audioPlayer");  

/* ================= PAGE ROUTING ================= */

const editorPage  = document.getElementById("editorPage");
const menuLinks = document.getElementById("menuLinks");
const hamburger = document.getElementById("hamburger");

function switchPage(target) {
    [editorPage].forEach(p => p.classList.add("hidden"));
    target.classList.remove("hidden");
    if(target !== editorPage) target.classList.add("flex");
    menuLinks.classList.add("hidden");
    hamburger.classList.remove("hidden");
}

document.getElementById("btnEditor").onclick = () => switchPage(editorPage);

hamburger.onclick = (e) => {
    e.stopPropagation();
    menuLinks.classList.toggle("hidden");
    hamburger.classList.toggle("hidden");
};
/* ================= EDITOR LOGIC ================= */
const PASSWORD = "1234";

function checkPassword() {
  const input = document.getElementById("passwordInput");
  if (input.value === PASSWORD) {
    document.getElementById("passwordSection").classList.add("hidden");
    document.getElementById("editorSection").classList.remove("hidden");
    // DEFAULT TEXT WITHOUT PERSONAL IDENTITY
    document.getElementById("greetingText").value = "Welcome to Bruk AI. I am ready to assist with your scientific research and natural language processing tasks.";
  } else {
    document.getElementById("errorMsg").classList.remove("hidden");
  }
}
/* ================= MULTI-MEDIA UPLOAD HANDLER ================= */
function previewMedia(input, type) {
    const file = input.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);

    if (type === 'video') {
        const player = document.getElementById('editorVideoPreview');
        player.src = url;
        player.load();
        player.play();
    } 
    else if (type === 'img') {
        document.getElementById('editorImagePreview').src = url;
        // Also update the public pages instantly
        document.getElementById('mainBotImgEn').src = url;
        document.getElementById('mainBotImgAm').src = url;
    } 
    else if (type === 'audio') {
        const audio = document.getElementById('editorAudioPreview');
        audio.src = url;
        audio.play();
    }
}

function saveChanges() {
  alert("System state saved. New configuration is now live.");
}

// Close menu on outside click
document.addEventListener("click", (e) => {
  if (!document.querySelector(".menu-container").contains(e.target)) {
    menuLinks.classList.add("hidden");
    hamburger.classList.remove("hidden");
  }
});

document.body.addEventListener("click", async() => {  

    if (micReady) return;  

    micReady = true;  

  audioPlayer.setAttribute("src","/assets/AmhstartAudio.mp3")

  audioPlayer.play()

      audioPlayer.onerror = (e) => {

            console.error("Audio element error:", e);

        };

     audioPlayer.onplay = () => {

       video.play()

       setTimeout(()=>{

                  loader.classList.add("d-none");

          isSpeaking=true

            image.classList.add("hidden");

            video.classList.remove("hidden");

             

       },700)

        };

     audioPlayer.onended = () => {

            video.classList.add("hidden");

            video.pause();

            image.classList.remove("hidden");

            isSpeaking=false

           audioPlayer.removeAttribute("src")

            initRecognition();

            startRecognition();

        };

}, { once: true });  

  

// Text-to-Speech  

function speakText(text, callback=null) {  

    const synth = window.speechSynthesis;  

    const utterance = new SpeechSynthesisUtterance(text);  

    utterance.lang = "am-ET";  

    utterance.rate = 0.9;  

    utterance.pitch = 0.8;  

  

    utterance.onstart = () => {

        isSpeaking = true;  

        image.classList.add("hidden");  

        video.classList.remove("hidden");  

        video.play();  

        if (recognition) try { recognition.abort(); } catch(e){}  

    };  

  

    utterance.onend = () => {  

        isSpeaking = false;  

        video.classList.add("hidden");  

        video.pause();  

        image.classList.remove("hidden");  

        if (callback) callback();  

    };  

  

    synth.speak(utterance);  

}  

  

// Initialize browser ASR  

function initRecognition() {  

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;  

    if (!SR) return console.log("SpeechRecognition not supported");  

  

    recognition = new SR();  

    recognition.lang = "am-ET";  

    recognition.continuous = true;       // continuous listening  

    recognition.interimResults = false;  

  

    recognition.onresult = async (evt) => {

    try {

        if (isSpeaking) return;

        // 1️⃣ Extract recognized text safely

        let text = "";

        try {

            text = evt.results[evt.results.length - 1][0].transcript.trim();

        } catch (e) {

            console.warn("Could not extract transcript:", e);

            return;

        }

        if (!text) {

            console.warn("Empty speech received.");

            return;

        }

        loader.classList.remove("d-none");

        console.log("User said:", text);

        isSpeaking=true

        // 2️⃣ Send text to backend

        let res;

        try {

            res = await fetch("/askAmharic", {

                method: "POST",

                headers: { "Content-Type": "application/json" },

                body: JSON.stringify({ text })

            });

        } catch (e) {

            console.error("Network error:", e);

            startRecognition(); // restart listening

            return;

        }



        // 3️⃣ Handle non-OK responses

        if (!res.ok) {

            console.error("Backend responded with error:", res.status, res.statusText);

            try {

                const errJson = await res.json();

                console.error("Backend error message:", errJson.error);

            } catch {

                console.error("Backend returned non-JSON error.");

            }

            isSpeaking=false

            startRecognition();

            return;

        }



        // 4️⃣ Play audio (with error catching)

        try {

            await playAudioBlob(res);

        } catch (e) {

            console.error("Audio playback failed:", e);

            startRecognition();

        }

        

       } catch (err) {

        // Final catch-all safeguard

        console.error("Recognition handler crashed:", err);

        startRecognition();

    }

};  

  

    recognition.onerror = (e) => console.log("STT Error:", e.error);  

    

    recognition.onend = () => {

    if (!isSpeaking) {

        console.log("Recognition ended automatically… restarting");

        setTimeout(()=>{

        startRecognition();

        },700)

    }

};

}  

  

// Start recognition safely  

  function startRecognition() {

    if (!recognition || isSpeaking) return;

    try {

        recognition.start();

    } catch (e) {

        console.warn("Restart failed, retrying...", e);

        setTimeout(() => startRecognition(), 500);

    }

}  



  async function getAudio(){

    let res;

        try {

    console.log("sent","ሰላም እኔ ብሩክ ግርማ ነኝ። የ12ኛ ክፍል የተጥሮ ሳይንስ ተማር ስሆን የተለያዩ ፈጠራዎችን በመስራት እታወቃለሁ። ዛሬ ምን ልረዳዎት እችላለሁ ?")     

    res = await fetch("http://localhost:3000/generateAudio", {

                method: "POST",

                headers: { "Content-Type": "application/json" },

                body: JSON.stringify({ text:"ሰላም እኔ ብሩክ ግርማ ነኝ። ዛሬ ምን ልረዳዎት እችላለሁ ?" })

            });

    playAudioBlob(res)

        } catch (e) {

            console.error("Network error:", e);

            startRecognition(); // restart listening

            return;

        }

  }

  

  async function playAudioBlob(res) {

    try {

        const audioBlob = await res.blob();

        const audioUrl = URL.createObjectURL(audioBlob);

        audioPlayer.src = audioUrl;

        

        audioPlayer.onerror = (e) => {

            console.error("Audio element error:", e);

        };



        audioPlayer.onplay = () => {

          loader.classList.add("d-none");

          isSpeaking=true

            image.classList.add("hidden");

            video.classList.remove("hidden");

            video.play();

        };



        audioPlayer.onended = () => {

            video.classList.add("hidden");

            video.pause();

            image.classList.remove("hidden");

            isSpeaking=false

            startRecognition();

        };

        audioPlayer.play();

    } catch (err) {

        console.error("playAudioBlob failed:", err);

        startRecognition();

    }

}

</script>

</body>  

  </html>
